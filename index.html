<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Navi + OSRM (TSP) + Live + Ziele sichtbar</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<style>
  :root { --bg:#0b0c0f; --txt:#eaeef6; --muted:#8b94a7; --accent:#4aa4ff; --ok:#33d17a; --err:#ff6b6b; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#0b0c0f; color:var(--txt);}
  header { position:sticky; top:0; z-index:5; background:#0f1320; border-bottom:1px solid #222; }
  .wrap { max-width: 1200px; margin: 0 auto; padding: 12px 14px; }
  h1 { margin:0 0 6px; font-size: 20px; }
  .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .btn { background: var(--accent); color:#00142a; border:none; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer; }
  .btn.secondary { background:#2a3142; color:var(--txt); }
  .hint { color:var(--muted); font-size:12px; }
  select, input[type="text"], input[type="date"] { background:#0f1320; color:#fff; border:1px solid #25314a; border-radius:8px; padding:6px 8px; }
  #map { height: 460px; border-radius: 14px; border:1px solid #242b3a; margin: 10px 0 6px; }
  .list { padding:16px; display:grid; grid-template-columns:1fr; gap:10px; }
  @media (min-width: 860px) { .list { grid-template-columns:1fr 1fr; } }
  .item { display:flex; justify-content:space-between; gap:10px; align-items:center;
           background:#141a28; border:1px solid #242b3a; border-radius:14px; padding:12px; }
  .name { font-weight:700; }
  .meta { font-size:12px; color:#8b94a7; }
  .pill { font-size:12px; padding:3px 8px; border-radius:999px; background:#2a3142; color:#aab5ce; }
  .error { color: var(--err); }
  .num { background:#0e1628; border:1px solid #2a3a52; color:#eaeef6; padding:2px 6px; border-radius:999px; font-size:12px; }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Navi-App + OSRM <span id="counter"></span></h1>
      <div class="controls">
        <label>Startpunkt</label>
        <select id="startSel">
          <option value="current">Aktueller Standort (GPS)</option>
          <option value="eling">Elinghorsterstr. 133, Gladbeck</option>
          <option value="wilhelm">Wilhelmstra√üe 60, Gladbeck</option>
        </select>
        <label>OSRM-Server</label>
        <input type="text" id="osrmUrl" size="34" value="https://router.project-osrm.org">
        <label for="workDate">Datum</label>
        <input type="date" id="workDate" value="2025-09-25">
        <button class="btn" id="btnShowTargets">Ziele auf Karte</button>
        <button class="btn" id="btnOptimize">Optimierte Route</button>
        <button class="btn secondary" id="btnStartNav">‚ñ∂Ô∏é Navigation starten</button>
        <button class="btn secondary" id="btnStopNav">‚è∏Ô∏è Stop</button>
        <label class="small"><input type="checkbox" id="voiceToggle"> Sprachausgabe</label>
        <span id="status" class="hint"></span>
      </div>

      <div id="map"></div>

      <div id="navbar">
        <span class="pill">N√§chster Schritt</span>
        <span id="nextInstr">‚Äì</span>
        <span id="nextDist"></span>
      </div>
      <div class="hint">GPS funktioniert nur √ºber <b>https</b> oder <b>localhost</b>. Bei Problemen mit der √∂ffentlichen OSRM-Demo trage deinen <b>eigenen OSRM-Server</b> ein.</div>
      <div id="diag" class="hint"></div>
      <div id="errBox" class="error"></div>
    </div>
  </header>

  <main class="wrap">
    <div id="list" class="list"></div>
  </main>

  <!-- Street modal -->
  <div class="overlay" id="ovStreet" role="dialog" aria-modal="true" hidden>
    <div class="card" role="document">
      <div class="card-head">
        <div>
          <div id="stTitle" style="font-weight:800;">Stra√üe</div>
          <div class="hint" id="stCoords"></div>
          <div class="hint">Datum: <span id="stDateLabel"></span></div>
        </div>
        <button class="btn secondary" id="stClose">Speichern & schlie√üen</button>
      </div>
      <div class="card-body">
        <label class="small" for="stScore">Verschmutzung (1‚Äì5)</label>
        <input id="stScore" type="range" min="1" max="5" step="1">
        <div class="hint">Wert: <span id="stScoreVal">3</span></div>

        <label class="small" for="stNote">Bemerkung</label>
        <textarea id="stNote" placeholder="Notizen‚Ä¶"></textarea>
      </div>
      <div class="card-foot">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button class="btn" id="stDone">Erledigt (f√ºr Datum speichern)</button>
          <a class="btn" id="stMaps" href="#" target="_blank" rel="noopener">üìç Google Maps</a>
          <span class="pill" id="stDoneBadge" style="display:none;">‚úì Erledigt</span>
        </div>
        <div class="hint">Nach dem Schlie√üen startet automatisch das n√§chste Ziel.</div>
      </div>
    </div>
  </div>

<script>
const DATA = [{"ortsteil": "Brauck", "name": "Antoniusstra√üe / Horsterstra√üe", "lat": 51.54625914715016, "lng": 7.003203083774897}, {"ortsteil": "Brauck", "name": "Boystra√üe / Ro√üheidestra√üe", "lat": 51.54628493420396, "lng": 7.003215842583171}, {"ortsteil": "Brauck", "name": "Breuckerstra√üe / Allkamperstra√üe", "lat": 51.54319985968724, "lng": 7.017070011107774}, {"ortsteil": "Brauck", "name": "Breukerstra√üe / Waterbruch", "lat": 51.541628097414005, "lng": 7.010418883840057}, {"ortsteil": "Brauck", "name": "Busnhof (vor Veba Wohnen)", "lat": 51.53530976474895, "lng": 7.006100268636323}, {"ortsteil": "Brauck", "name": "Heringstra√üe / Matthiasstra√üe", "lat": 51.53970249578254, "lng": 7.00491970232721}, {"ortsteil": "Brauck", "name": "Horster Stra√üe (an der Autobahnbr√ºcke)", "lat": 51.55784728253204, "lng": 7.001433210899876}, {"ortsteil": "Brauck", "name": "Klarastra√üe / Ewaldstra√üe", "lat": 51.55508033354896, "lng": 7.003585198541663}, {"ortsteil": "Brauck", "name": "Kortenkamp (am Parkplatz)", "lat": 51.54501596729244, "lng": 7.014141896576403}, {"ortsteil": "Brauck", "name": "Marienstra√üe (gegen√ºber 42)", "lat": 51.55186289437827, "lng": 7.008448769710327}, {"ortsteil": "Brauck", "name": "Ro√üheidestra√üe / Schongauerstra√üe", "lat": 51.55031224116994, "lng": 7.002665075579771}, {"ortsteil": "Brauck", "name": "Uferstra√üe / Emmichstra√üe / Waterbruch", "lat": 51.53524939041824, "lng": 7.0109092864854405}, {"ortsteil": "Brauck", "name": "Welheimstra√üe (am Sportplatz)", "lat": 51.55261149227467, "lng": 7.001828736999908}, {"ortsteil": "Butendorf", "name": "Diepenbrockstra√üe / Ph√∂nixstra√üe", "lat": 51.55715481219906, "lng": 6.990572668904578}, {"ortsteil": "Butendorf", "name": "Zum Stadtwald gegen√ºber Schachtstra√üe", "lat": 51.56237006788999, "lng": 6.996212666546319}, {"ortsteil": "Butendorf", "name": "Erlengrund / Ringeldorferstra√üe", "lat": 51.571139722880126, "lng": 7.006721940246049}, {"ortsteil": "Butendorf", "name": "G√∂rlitzer Stra√üe 22", "lat": 51.56841445693835, "lng": 7.004975194211555}, {"ortsteil": "Butendorf", "name": "Helmutstra√üe / Franzstra√üe", "lat": 51.55563258833122, "lng": 6.997407118751156}, {"ortsteil": "Butendorf", "name": "Im Linnerott / Landstra√üe", "lat": 51.55902086965974, "lng": 7.006770129225385}, {"ortsteil": "Butendorf", "name": "Johannastra√üe / Welheimer Stra√üe", "lat": 51.55308563385059, "lng": 6.998888146554648}, {"ortsteil": "Butendorf", "name": "Lukasstra√üe / Markusstra√üe", "lat": 51.561884299292174, "lng": 7.0025816722457295}, {"ortsteil": "Butendorf", "name": "Steinstra√üe 72", "lat": 51.56344264855052, "lng": 6.991908195731704}, {"ortsteil": "Butendorf", "name": "Wielandstra√üe / Bramsfeld", "lat": 51.56578168928559, "lng": 7.0057589462895775}, {"ortsteil": "Butendorf", "name": "Wielandstra√üe / Erlengrund", "lat": 51.56838943356056, "lng": 7.010343767399531}, {"ortsteil": "Mitte", "name": "Bergmanstra√üe / Festplatz", "lat": 51.56726778571375, "lng": 6.995163766598645}, {"ortsteil": "Mitte", "name": "Bottroper Stra√üe / Am Allhagen", "lat": 51.57195285535048, "lng": 6.983350762415913}, {"ortsteil": "Mitte", "name": "Burgstra√üe (Parkplatz - Wittringen)", "lat": 51.55994843091297, "lng": 6.985576562058606}, {"ortsteil": "Mitte", "name": "Friedrichstra√üe (Parkplatz Goethestra√üe)", "lat": 51.57159959842792, "lng": 6.991064340662864}, {"ortsteil": "Mitte", "name": "Friedrichstra√üe Stadthalle", "lat": 51.57154021885789, "lng": 6.988667472086899}, {"ortsteil": "Mitte", "name": "Gildenstra√üe / Bottroper Stra√üe", "lat": 51.56749925903403, "lng": 6.972495255869703}, {"ortsteil": "Mitte", "name": "Gildenstra√üe Hausnummer 62", "lat": 51.56756008327928, "lng": 6.978029684811616}, {"ortsteil": "Mitte", "name": "Hansemannstra√üe (West Bahnhof)", "lat": 51.57478376601955, "lng": 6.977633571127178}, {"ortsteil": "Mitte", "name": "Herderstra√üe / Pa√ümannstra√üe", "lat": 51.57578487612062, "lng": 6.983642076265571}, {"ortsteil": "Mitte", "name": "Kirchstra√üe (Lambertischule)", "lat": 51.57282376181088, "lng": 6.995449817468783}, {"ortsteil": "Mitte", "name": "Postallee / Lessingstra√üe", "lat": 51.57808280271068, "lng": 6.987842299561366}, {"ortsteil": "Mitte", "name": "Postallee / Mittelstra√üe", "lat": 51.57550379588669, "lng": 6.988975872764374}, {"ortsteil": "Mitte", "name": "Uhlandstra√üe (am Kindergarten)", "lat": 51.56890547653634, "lng": 6.9931710020037015}, {"ortsteil": "Mitte", "name": "Uhlandstra√üe 58", "lat": 51.56871741687351, "lng": 6.987414377051908}, {"ortsteil": "Mitte", "name": "Wilhelmstra√üe (Parkplatz - Feuerwehr)", "lat": 51.57106292680989, "lng": 6.9980850140346185}, {"ortsteil": "Mitte", "name": "Zwecklerstra√üe (unter Buersche - Br√ºcke)", "lat": 51.575410448964114, "lng": 6.994506900891496}, {"ortsteil": "Rosenh√ºgel", "name": "Otto - Hue - Stra√üe / Am alten Sportplatz", "lat": 51.55050484922371, "lng": 7.015135696314324}, {"ortsteil": "Rosenh√ºgel", "name": "M√ºnsterl√§nder Am Marktplatz", "lat": 51.54653476699367, "lng": 7.014130349523563}, {"ortsteil": "Rosenh√ºgel", "name": "Sauerl√§nder Stra√üe / Holthauser Stra√üe", "lat": 51.55097902878654, "lng": 7.026211407990159}, {"ortsteil": "Rosenh√ºgel", "name": "Schulte - Berge - Stra√üe (gegen√ºber dem Spielplatz)", "lat": 51.54490746322997, "lng": 7.02253369299852}, {"ortsteil": "Rosenh√ºgel", "name": "Vehrenbergstra√üe (am Wald)", "lat": 51.54762890503404, "lng": 7.024709687343224}, {"ortsteil": "Rosenh√ºgel", "name": "Vehrenbergstra√üe / Rostocker Stra√üe", "lat": 51.54696554867783, "lng": 7.021774177592603}];
document.getElementById('counter').textContent = '(Stra√üen: ' + DATA.length + ')';

const errBox = document.getElementById('errBox');
const diag = document.getElementById('diag');
function showErr(msg){ errBox.textContent = msg || ''; }
function clearErr(){ errBox.textContent=''; }
function setDiag(msg){ diag.textContent = msg || ''; }

// Fixed coords (fallback for start selection)
const FIXED = {
  eling: { lat: 51.5686, lng: 6.9892 },    // approx; Elinghorsterstr. 133
  wilhelm: { lat: 51.57091, lng: 6.998884 } // Wilhelmstra√üe 60
};

// ---------- Utils & storage ----------
function keyDaily(name, iso){ return 'brauck_daily::' + name + '::' + iso; }
function loadDaily(name, iso){ try { return JSON.parse(localStorage.getItem(keyDaily(name,iso))) || {}; } catch { return {}; } }
function saveDaily(name, iso, st){ localStorage.setItem(keyDaily(name,iso), JSON.stringify(st)); }
function buildMapsLink(lat, lng, name){
  const n = encodeURIComponent(name || '');
  const isAndroid = /Android/i.test(navigator.userAgent);
  if (isAndroid) return 'geo:' + lat + ',' + lng + '?q=' + lat + ',' + lng + '(' + n + ')';
  return 'https://www.google.com/maps/search/?api=1&query=' + lat + ',' + lng;
}
function haversine(a,b){
  const R=6371000;
  const toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng);
  const s=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
}

// ---------- Leaflet map ----------
let map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
map.setView([51.5709, 6.9989], 12);
let routeLayer = L.geoJSON(null).addTo(map);
let markerLayer = L.layerGroup().addTo(map);
function clearMap(){ routeLayer.clearLayers(); markerLayer.clearLayers(); }
function addMarker(lat,lng,label){ L.marker([lat,lng], {title: label}).addTo(markerLayer).bindPopup(label); }
function addNumberedMarker(lat,lng,num,label){
  const icon = L.divIcon({className:'num', html:String(num), iconSize:[20,20]});
  L.marker([lat,lng], {title: label, icon}).addTo(markerLayer).bindPopup(num+'. '+label);
}

// ---------- UI list ----------
const listEl = document.getElementById('list');
function renderList(arr){
  listEl.innerHTML='';
  arr.forEach((it)=>{
    const st=loadDaily(it.name, workDate.value);
    const d=document.createElement('div'); d.className='item';
    d.innerHTML = '<div><div class="name">'+it.name+'</div>' +
                  '<div class="meta">'+(it.lat!=null&&it.lng!=null?('Lat '+Number(it.lat).toFixed(6)+', Lng '+Number(it.lng).toFixed(6)):'‚ö†Ô∏é keine Koordinaten')+
                  (st.done?' ‚Ä¢ ‚úì erledigt':'')+(st.score?(' ‚Ä¢ Verschm: '+st.score):'')+'</div></div>' +
                  '<div><button class="btn secondary">√ñffnen</button></div>';
    d.querySelector('button').addEventListener('click', ()=>openStreet(it));
    listEl.appendChild(d);
  });
}
renderList(DATA);

// ---------- Show all valid targets on map ----------
function plotTargets(){
  clearMap();
  const pts = DATA.filter(it => it.lat!=null && it.lng!=null);
  pts.forEach((it, idx) => addNumberedMarker(it.lat, it.lng, idx+1, it.name));
  if (pts.length){
    map.fitBounds(L.latLngBounds(pts.map(p=>[p.lat, p.lng])), {padding:[20,20]});
  }
  setDiag('Ziele sichtbar: '+pts.length+' / '+DATA.length+' (ohne Koordinaten werden ignoriert)');
}
plotTargets(); // initial

document.getElementById('btnShowTargets').addEventListener('click', plotTargets);

// ---------- GPS ----------
function getGPS(){
  return new Promise((resolve)=>{
    if (!location.protocol.startsWith('http')) return resolve(null);
    if (!navigator.geolocation) return resolve(null);
    navigator.geolocation.getCurrentPosition(p=>resolve({lat:p.coords.latitude, lng:p.coords.longitude}), _=>resolve(null), {enableHighAccuracy:true,timeout:10000});
  });
}

// ---------- OSRM optimize (TSP via /table + 2-opt) ----------
function tspOrder(durs){
  const n = durs.length;
  const unvisited = new Set(Array.from({length:n-1}, (_,i)=>i+1));
  const route = [0];
  let cur = 0;
  while (unvisited.size){
    let best=null, bestVal=Infinity;
    for (const j of unvisited){ const v=durs[cur][j]; if (v<bestVal){best=j; bestVal=v;} }
    route.push(best); unvisited.delete(best); cur = best;
  }
  function dist(i,j){ return durs[route[i]][route[j]]; }
  let improved=true;
  while (improved){
    improved=false;
    for (let i=1;i<route.length-2;i++){ for (let k=i+1;k<route.length-1;k++){ 
      const delta=(dist(i-1,i)+dist(k,k+1))-(dist(i-1,k)+dist(i,k+1));
      if (delta>1e-9){ const slice=route.slice(i,k+1).reverse(); route.splice(i,k-i+1,...slice); improved=true; }
    }}
  }
  return route;
}

async function osrmTableDurations(osrmBase, coordsLonLat){
  const base = osrmBase.replace(/\/$/, '');
  const coordStr = coordsLonLat.map(p=>p.join(',')).join(';');
  const url = base + '/table/v1/driving/' + coordStr + '?annotations=duration';
  const r = await fetch(url);
  if (!r.ok) throw new Error('OSRM /table Fehler '+r.status);
  const j = await r.json();
  if (!j.durations) throw new Error('Keine durations erhalten.');
  return j.durations;
}

async function optimizeOSRM(start, osrmBase){
  clearErr();
  const targets = DATA.filter(it => it.lat!=null && it.lng!=null);
  if (!start) throw new Error('Kein Startpunkt verf√ºgbar.');
  if (targets.length < 1) throw new Error('Keine Ziele mit Koordinaten.');
  const coords = [[start.lng, start.lat], ...targets.map(t=>[t.lng, t.lat])];
  const durations = await osrmTableDurations(osrmBase, coords);
  const orderIdx = tspOrder(durations);
  const orderedTargets = orderIdx.slice(1).map(i => targets[i-1]);
  const names = orderedTargets.map(x=>x.name);
  const byName=new Map(DATA.map(x=>[x.name,x])); const newOrder=[]; names.forEach(n=>{newOrder.push(byName.get(n)); byName.delete(n);}); byName.forEach(v=>newOrder.push(v));
  DATA.splice(0,DATA.length,...newOrder);
  renderList(DATA);
  // show numbered markers in optimized order (1..n starting at first waypoint)
  clearMap();
  addNumberedMarker(start.lat, start.lng, 0, 'Start');
  orderedTargets.forEach((it, idx) => addNumberedMarker(it.lat, it.lng, idx+1, it.name));
  map.fitBounds(L.latLngBounds([[start.lat,start.lng], ...orderedTargets.map(p=>[p.lat,p.lng])]), {padding:[20,20]});
  return orderIdx.map(i=>coords[i]); // lon,lat
}

// ---------- Build route per leg ----------
async function buildRoutePerLeg(osrmBase, coordsLonLat){
  const base = osrmBase.replace(/\/$/, '');
  const legs = [];
  const latlngs = coordsLonLat.map(c=>[c[1], c[0]]);
  for (let i=1;i<latlngs.length;i++){
    const part = base + '/route/v1/driving/' + coordsLonLat[i-1].join(',') + ';' + coordsLonLat[i].join(',') + '?overview=full&geometries=geojson&steps=true';
    const r = await fetch(part);
    if (!r.ok){ throw new Error('OSRM /route Fehler '+r.status+' (Leg '+i+')'); }
    const j = await r.json();
    if (!j.routes || !j.routes[0]) throw new Error('Keine Route (Leg '+i+')');
    routeLayer.addData(j.routes[0].geometry);
    legs.push(j.routes[0].legs[0]);
  }
  return legs.map((leg, idx)=>({
    idx, distance: leg.distance, duration: leg.duration,
    steps: leg.steps.map(s=>({
      name: s.name || '',
      distance: s.distance,
      duration: s.duration,
      maneuver: s.maneuver,
      geometry: s.geometry
    }))
  }));
}

// ---------- Street modal ----------
const workDate = document.getElementById('workDate');
const ovStreet = document.getElementById('ovStreet');
const stClose = document.getElementById('stClose');
const stTitle = document.getElementById('stTitle');
const stCoords = document.getElementById('stCoords');
const stDateLabel = document.getElementById('stDateLabel');
const stScore = document.getElementById('stScore');
const stScoreVal = document.getElementById('stScoreVal');
const stNote = document.getElementById('stNote');
const stDone = document.getElementById('stDone');
const stDoneBadge = document.getElementById('stDoneBadge');
const stMaps = document.getElementById('stMaps');

let activeItem = null;
let pendingResumeNav = false;

function showOverlay(el){ el.removeAttribute('hidden'); }
function hideOverlay(el){ el.setAttribute('hidden',''); }

function openStreet(it){
  activeItem = it;
  const iso = workDate.value;
  const st = loadDaily(it.name, iso);
  stTitle.textContent = it.name;
  stDateLabel.textContent = iso;
  if (it.lat!=null && it.lng!=null) {
    const la = Number(it.lat).toFixed(6), lo = Number(it.lng).toFixed(6);
    stCoords.textContent = 'Lat: ' + la + ', Lng: ' + lo;
    stMaps.setAttribute('href', buildMapsLink(la, lo, it.name));
  } else {
    stCoords.textContent = 'Keine Koordinaten';
    stMaps.setAttribute('href', '#');
  }
  stScore.value = st.score ?? 3;
  stScoreVal.textContent = stScore.value;
  stNote.value = st.note ?? '';
  stDoneBadge.style.display = st.done ? 'inline-block' : 'none';
  stDone.textContent = st.done ? 'Als nicht erledigt markieren' : 'Erledigt (f√ºr Datum speichern)';
  showOverlay(ovStreet);
}

stScore.addEventListener('input', () => { stScoreVal.textContent = stScore.value; });
stDone.addEventListener('click', () => {
  if (!activeItem) return;
  const iso = workDate.value;
  const st = loadDaily(activeItem.name, iso);
  st.done = !st.done;
  st.score = parseInt(stScore.value, 10);
  st.note = stNote.value.trim();
  saveDaily(activeItem.name, iso, st);
  stDoneBadge.style.display = st.done ? 'inline-block' : 'none';
  stDone.textContent = st.done ? 'Als nicht erledigt markieren' : 'Erledigt (f√ºr Datum speichern)';
});
stClose.addEventListener('click', () => {
  if (activeItem) {
    const iso = workDate.value;
    const st = loadDaily(activeItem.name, iso);
    st.score = parseInt(stScore.value, 10);
    st.note = stNote.value.trim();
    saveDaily(activeItem.name, iso, st);
  }
  hideOverlay(ovStreet);
  if (pendingResumeNav) { pendingResumeNav=false; gotoNextWaypoint(); }
});

// ---------- Live navigation ----------
const btnShowTargets = document.getElementById('btnShowTargets');
const btnOptimize = document.getElementById('btnOptimize');
const btnStartNav = document.getElementById('btnStartNav');
const btnStopNav = document.getElementById('btnStopNav');
const startSel = document.getElementById('startSel');
const osrmUrl = document.getElementById('osrmUrl');
const status = document.getElementById('status');
const nextInstr = document.getElementById('nextInstr');
const nextDist = document.getElementById('nextDist');
const voiceToggle = document.getElementById('voiceToggle');

let optimizedCoords = null; // [ [lon,lat], ... ] incl start
let waypointNames = null;   // names aligned with DATA order used
let stepsByLeg = null;      // per leg steps
let curLeg = 0;             // 0 => start->first waypoint
let curStep = 0;
let watchId = null;
let arrivingThresholdM = 40; // distance to consider arrived at waypoint

function speak(text){
  try {
    if (!voiceToggle.checked) return;
    const u = new SpeechSynthesisUtterance(text);
    speechSynthesis.cancel(); // avoid overlap
    speechSynthesis.speak(u);
  } catch(e){ console.log('speech error', e); }
}

async function determineStart(){
  if (startSel.value==='current'){
    const p = await getGPS();
    if (!p) throw new Error('Kein GPS unter https/localhost.');
    return p;
  }
  if (startSel.value==='eling'){ return FIXED.eling; }
  if (startSel.value==='wilhelm'){ return FIXED.wilhelm; }
  throw new Error('Unbekannter Startpunkt');
}

btnOptimize.addEventListener('click', async ()=>{
  try {
    clearErr();
    status.textContent = 'Startpunkt wird ermittelt‚Ä¶';
    const start = await determineStart();
    status.textContent = 'Optimierung l√§uft (OSRM /table)‚Ä¶';
    optimizedCoords = await optimizeOSRM(start, osrmUrl.value); // includes start first
    waypointNames = DATA.filter(it=>it.lat!=null && it.lng!=null).map(it=>it.name);
    status.textContent = 'Route abrufen (OSRM /route per Leg)‚Ä¶';
    stepsByLeg = await buildRoutePerLeg(osrmUrl.value, optimizedCoords);
    curLeg = 0; curStep = 0;
    updateNextInstruction();
    status.textContent = 'Bereit.';
  } catch(e){
    console.error(e); status.textContent = 'Fehler: '+e.message; showErr(e.message);
  }
});

function updateNextInstruction(){
  if (!stepsByLeg){ nextInstr.textContent='‚Äì'; nextDist.textContent=''; return; }
  const leg = stepsByLeg[curLeg];
  if (!leg || !leg.steps || !leg.steps.length){ nextInstr.textContent='‚Äì'; nextDist.textContent=''; return; }
  const step = leg.steps[curStep];
  if (!step){ nextInstr.textContent='‚Äì'; nextDist.textContent=''; return; }
  const m = step.maneuver || {};
  const dir = (m.modifier ? m.modifier : (m.type||'')).replace('_',' ');
  const street = step.name || '';
  const dist = Math.round(step.distance);
  const text = (m.instruction ? m.instruction : (dir?(''+dir):'Folgen')) + (street?(' auf '+street):'');
  nextInstr.textContent = text;
  nextDist.textContent = '‚âà ' + dist + ' m';
}

function advanceStep(){
  const leg = stepsByLeg[curLeg];
  if (!leg) return false;
  if (curStep < leg.steps.length - 1){ curStep++; updateNextInstruction(); return true; }
  return false;
}

function advanceLeg(){
  if (curLeg < stepsByLeg.length - 1){ curLeg++; curStep = 0; updateNextInstruction(); return true; }
  return false;
}

function gotoNextWaypoint(){
  if (advanceLeg()){ speak('Weiter zum n√§chsten Ziel.'); restartWatch(); return; }
  nextInstr.textContent = 'Tour abgeschlossen. Gute Arbeit!';
  nextDist.textContent = '';
  speak('Tour abgeschlossen. Gute Arbeit!');
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
}

function restartWatch(){
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  startWatch();
}

function startWatch(){
  if (!stepsByLeg){ status.textContent = 'Bitte zuerst "Optimierte Route" berechnen.'; return; }
  status.textContent = 'Navigation l√§uft‚Ä¶';
  speak('Navigation gestartet.');
  watchId = navigator.geolocation.watchPosition(pos => {
    const here = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    const nextWp = optimizedCoords[curLeg+1];
    const dToWp = haversine(here, {lat: nextWp[1], lng: nextWp[0]});
    nextDist.textContent = '‚âà ' + Math.round(dToWp) + ' m';
    const leg = stepsByLeg[curLeg];
    if (leg && leg.steps && leg.steps[curStep]){
      const man = leg.steps[curStep].maneuver;
      if (man && man.location){
        const dStep = haversine(here, {lat: man.location[1], lng: man.location[0]});
        if (dStep < 25) { if (advanceStep()) speak(nextInstr.textContent); }
      }
    }
    if (dToWp < 40) {
      const name = waypointNames && waypointNames[curLeg] ? waypointNames[curLeg] : null;
      if (name){
        const it = DATA.find(x => x.name === name);
        if (it) { openStreet(it); pendingResumeNav = true; }
      }
      navigator.geolocation.clearWatch(watchId); watchId=null;
      status.textContent = 'Ankunft: ' + (name || 'Ziel') + ' ‚Äì Eingabe speichern und schlie√üen f√ºr n√§chstes Ziel.';
      speak('Ziel erreicht. Bitte Eingabe speichern.');
    }
  }, err => { status.textContent = 'GPS-Fehler: '+err.message; showErr('GPS: '+err.message); }, { enableHighAccuracy:true, maximumAge:5000, timeout:15000 });
}

document.getElementById('btnShowTargets').addEventListener('click', plotTargets);
document.getElementById('btnStartNav').addEventListener('click', startWatch);
document.getElementById('btnStopNav').addEventListener('click', ()=>{ if (watchId) { navigator.geolocation.clearWatch(watchId); watchId=null; } status.textContent='Navigation gestoppt.'; speak('Navigation gestoppt.'); });
</script>
</body>
</html>
